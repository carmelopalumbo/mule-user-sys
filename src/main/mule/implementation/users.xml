<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core" xmlns:db="http://www.mulesoft.org/schema/mule/db"
	xmlns="http://www.mulesoft.org/schema/mule/core"
	xmlns:doc="http://www.mulesoft.org/schema/mule/documentation" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
http://www.mulesoft.org/schema/mule/db http://www.mulesoft.org/schema/mule/db/current/mule-db.xsd
http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd">
	<sub-flow name="get-users" doc:id="3d665b20-595e-4d08-8bf7-de0d1ac4d829" >
		<logger level="INFO" doc:name="Start flow" doc:id="121ad746-ecf6-4283-8782-32bd5ca937f6" message='#["Start flow GET users with correlationId: " ++ (vars.correlationId default "N/A")]' />
		<ee:transform doc:name="Set DB query" doc:id="37817315-172e-42d8-8ac8-acd75b9c3645">
			<ee:message>
				<ee:set-payload><![CDATA[%dw 2.0
output application/json
---
if((!isEmpty(attributes.queryParams.firstName)) and (!isEmpty(attributes.queryParams.lastName)))
    "SELECT * FROM users_db.users WHERE name='" ++ attributes.queryParams.firstName ++ "' AND lastName='" ++ attributes.queryParams.lastName ++ "'"
else if(!isEmpty(attributes.queryParams.firstName))
    "SELECT * FROM users_db.users WHERE name='" ++ attributes.queryParams.firstName ++ "'"
else if(!isEmpty(attributes.queryParams.lastName))
    "SELECT * FROM users_db.users WHERE lastName='" ++ attributes.queryParams.lastName ++ "'"
else
    "SELECT * FROM users_db.users"]]></ee:set-payload>
			</ee:message>
			<ee:variables>
			</ee:variables>
		</ee:transform>
		<flow-ref doc:name="db-orchestrator-select" doc:id="70c6e30c-0d73-43e5-870d-9a5147ba2530" name="db-orchestrator-select"/>
		<ee:transform doc:name="Payload to JSON" doc:id="8305668a-e259-4e1c-8d67-8325f8bdbeff">
			<ee:message>
				<ee:set-payload><![CDATA[%dw 2.0
output application/json
---
payload]]></ee:set-payload>
			</ee:message>
		</ee:transform>
		<logger level="DEBUG" doc:name="Debug payload after SELECT" doc:id="6caaf2e2-9dfc-4c09-9f73-52b3b69a9ba3" message='#["DEBUG payload after SELECT: " ++ payload.^raw]'/>
		<logger level="INFO" doc:name="End flow" doc:id="46f59dcc-1a6e-4f12-b54a-67095ff75e96" message='#["Start flow GET users with correlationId: " ++ (vars.correlationId default "N/A")]' />
	</sub-flow>
	<sub-flow name="get-users-by-id" doc:id="04028ae2-300f-4840-8538-a88bc7cb6bde" >
		<logger level="INFO" doc:name="Start flow" doc:id="bb1dc202-5f63-467a-8d05-87066ceb73a9" message='#["Start flow GET users by id with correlationId: " ++ (vars.correlationId default "N/A")]' />
		<ee:transform doc:name="userId" doc:id="62a536c5-ff51-4fff-92b9-49bf6a2bac9b" >
			<ee:message >
			</ee:message>
			<ee:variables >
				<ee:set-variable variableName="userId" ><![CDATA[%dw 2.0
output application/json
---
attributes.uriParams.userId as String default null]]></ee:set-variable>
			</ee:variables>
		</ee:transform>
		<ee:transform doc:name="Set DB query" doc:id="99e2e202-3d07-49fd-a0aa-c0309e3bd25e">
			<ee:message>
				<ee:set-payload><![CDATA[%dw 2.0
output application/json
---
"SELECT * FROM users_db.users WHERE id=" ++ vars.userId]]></ee:set-payload>
			</ee:message>
			<ee:variables />
		</ee:transform>
		<flow-ref doc:name="db-orchestrator-select" doc:id="32f344db-fc9d-42ac-a9b7-43c7f2a2610b" name="db-orchestrator-select" />
		<ee:transform doc:name="Payload to JSON" doc:id="1130b8b1-b2b9-4a1f-b24b-3b81c919d9fe">
			<ee:message>
				<ee:set-payload><![CDATA[%dw 2.0
output application/json
---
payload]]></ee:set-payload>
			</ee:message>
		</ee:transform>
		<logger level="INFO" doc:name="End flow" doc:id="60edecf2-f2e2-4f6d-bc67-312f8ac8d27c" message='#["Start flow GET users by id with correlationId: " ++ (vars.correlationId default "N/A")]' />
	</sub-flow>
	<sub-flow name="post-users" doc:id="16055850-be66-4e82-b858-b6e5b5ee15b7" >
		<logger level="INFO" doc:name="Start flow" doc:id="dba8408e-f82c-476f-9c36-8710222644b0" message='#["Start flow POST users by id with correlationId: " ++ (vars.correlationId default "N/A")]' />
		<logger level="DEBUG" doc:name="Debug payload before SELECT" doc:id="6ff43967-2618-4e53-87ac-fa38cf6db2ce" message='#["Debug payload before SELECT: " ++ payload.^raw]'/>
		<ee:transform doc:name="Set DB query" doc:id="0553d50c-939e-4b2e-a9dc-537937c8b6fe" >
			<ee:message >
				<ee:set-payload ><![CDATA[%dw 2.0
output application/json
---
"INSERT INTO users (name, lastName, email, address) VALUES ('" ++ payload.firstName ++ "', '" ++ payload.lastName ++ "', '" ++ payload.email ++ "', '" ++ payload.address ++ "')"]]></ee:set-payload>
			</ee:message>
		</ee:transform>
		<flow-ref doc:name="db-orchestrator-insert" doc:id="f0ab8b7b-d3fb-40c7-94be-898709227bf7" name="db-orchestrator-insert" />
		<logger level="INFO" doc:name="INSERT ok" doc:id="6cc25b2b-1e39-492c-b2da-25b976544a9e" message='#["New user OK"]'/>
		<logger level="INFO" doc:name="End flow" doc:id="207a01a3-0501-447f-8206-e114f618c4be" message='#["Start flow POST users by id with correlationId: " ++ (vars.correlationId default "N/A")]' />
	</sub-flow>
	<sub-flow name="put-users" doc:id="a085e5e6-8f8d-4f09-bbcd-9410dbe16604" >
		<logger level="INFO" doc:name="Logger" doc:id="41184d2c-74f8-46cc-989a-23ae333c0320" message="test" />
	</sub-flow>
	<sub-flow name="patch-users" doc:id="f6e81dca-30a4-452f-bb85-6fabafb8641f" >
		<logger level="INFO" doc:name="Logger" doc:id="f669e289-6cf9-40cc-997d-5b8765cdfc5b" message="test" />
	</sub-flow>
	<sub-flow name="delete-users" doc:id="d2c4cb1b-6b78-4269-af46-ce398f3b0440" >
		<logger level="INFO" doc:name="Logger" doc:id="3e8d8c40-be66-47d4-b039-361548be78df" message="test" />
	</sub-flow>
</mule>
